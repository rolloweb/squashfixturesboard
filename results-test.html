<!-- BEGIN MAIN APP SCRIPT -->
<script>
/* ========= Data comes from your page ========= */
const DATA = window.DATA;          // keep existing DATA array defined earlier in your file
const RESULTS = window.RESULTS;    // keep existing RESULTS array defined earlier in your file

/* ========= Helpers ========= */
function parseDate(textDate, time) {
  const m = textDate.match(/(\d{1,2})\s(\w{3})\s(\d{4})/);
  if (!m) return null;
  const [_, d, mon, y] = m;
  const months = {Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11};
  const t = time && time.match(/(\d{1,2}):(\d{2})(am|pm)/i);
  let hh = 19, mm = 0;
  if (t) {
    hh = +t[1]; mm = +t[2];
    const ap = t[3].toLowerCase();
    if (ap === 'pm' && hh < 12) hh += 12;
    if (ap === 'am' && hh === 12) hh = 0;
  }
  return new Date(+y, months[mon], +d, hh, mm);
}
function monthKey(dt){ return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0'); }
function divisionClass(div){ return div.toLowerCase().replace(' ', ''); }
function isAllDivisions(val){ return !val || String(val).toLowerCase().startsWith('all'); }
function mapsLink(place){ if (!place || place === '-' || String(place).toLowerCase() === 'bye') return '#'; return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(place); }
const pad = n => String(n).padStart(2,'0');
function fmtLocal(d){ return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'T'+pad(d.getHours())+pad(d.getMinutes())+'00'; }
function googleCalLink(ev){
  const start = ev.dt, end = new Date(start.getTime()+90*60000);
  const q = new URLSearchParams({
    action:'TEMPLATE',
    text: `PTSRC vs ${ev.opponent} (${ev.home ? 'Home':'Away'})`,
    details:'League fixture – check league site for any updates.',
    location: ev.location,
    dates: `${fmtLocal(start)}/${fmtLocal(end)}`
  });
  return 'https://calendar.google.com/calendar/render?' + q.toString();
}
function makeICS(ev){
  const start = ev.dt, end = new Date(start.getTime()+90*60000);
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//PTSRC//Fixtures//EN','BEGIN:VEVENT',
    `UID:${Date.now()}-${Math.random().toString(36).slice(2)}@ptsquash`,
    `DTSTAMP:${fmtLocal(new Date())}`,
    `DTSTART:${fmtLocal(start)}`,
    `DTEND:${fmtLocal(end)}`,
    `SUMMARY:PTSRC vs ${ev.opponent} (${ev.home?'Home':'Away'})`,
    `LOCATION:${ev.location.replace(/,/g,'\\,')}`,
    'DESCRIPTION:League fixture – check league site for updates.','END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  return URL.createObjectURL(new Blob([ics], {type:'text/calendar'}));
}

/* ========= Build a fast result index: Div|YYYY-MM-DD|location ========= */
const RESULT_INDEX = (() => {
  const m = new Map();
  (RESULTS || []).forEach(r => {
    m.set(`${r.division}|${r.date_iso}|${String(r.location).toLowerCase()}`, r);
  });
  return m;
})();

function findResultFor(ev){
  const iso = ev.dt.toISOString().slice(0,10);
  const keyLoc = `${ev.division}|${iso}|${ev.location.toLowerCase()}`;
  const keyOpp = `${ev.division}|${iso}|${(ev.opponent.split(' ')[0]||'').toLowerCase()}`;
  return RESULT_INDEX.get(keyLoc) || RESULT_INDEX.get(keyOpp) || null;
}

/* ========= LIST VIEW ========= */
function renderList(){
  const divSel   = document.getElementById('division').value;
  const sportSel = document.getElementById('sport').value;
  const list = document.getElementById('list');
  list.innerHTML = '';
  let count = 0;

  DATA.map(r => ({...r, dt: parseDate(r.date, r.time), monthKey:null})).forEach(ev => {
    if (!ev.dt) return;
    ev.monthKey = monthKey(ev.dt);
    if (!isAllDivisions(divSel) && ev.division !== divSel) return;
    if (sportSel && ev.sport !== sportSel) return;

    const card = document.createElement('div');
    const divCls = divisionClass(ev.division);
    card.className = 'card side-stripe ' + divCls;
    card.style.borderLeftColor = getComputedStyle(document.documentElement).getPropertyValue('--' + divCls);

    const home = ev.homeAway.toLowerCase() === 'home';
    const maps = mapsLink(ev.location);
    const gcal = googleCalLink({...ev, home});
    const ics  = makeICS({...ev, home});

    // show "See results" when available
    const res = findResultFor(ev);
    let actionsHtml = '';
    if (res) {
      const payload = JSON.stringify({ division: ev.division, date: ev.date, time: ev.time, opponent: ev.opponent });
      actionsHtml = `<a class="btn" href="#" onclick='openResult(${payload}); return false;'>See results</a>`;
    } else {
      actionsHtml = `
        <a class="btn" href="${gcal}" target="_blank" rel="noopener">Add to Google</a>
        <a class="btn secondary" href="${ics}" download="PTSRC_${ev.division.replace(' ','')}_${ev.opponent.replace(/\s+/g,'')}_${ev.monthKey}.ics">Download .ics</a>
      `;
    }

    const homePill = `<span class="${home ? 'home-pill' : 'away-pill'}">${home ? 'HOME' : 'AWAY'}</span>`;
    const divBadge = `<span class="division-badge ${divCls}">${ev.division}</span>`;

    card.innerHTML = `
      <div class="row-top">
        <div class="date">${ev.date} • ${ev.time}</div>
        ${divBadge}
      </div>
      <div class="opponent">${homePill}<strong>${ev.opponent}</strong></div>
      <div class="meta"><a href="${maps}" target="_blank" rel="noopener">${ev.location}</a></div>
      <div class="actions">${actionsHtml}</div>
    `;
    list.appendChild(card);
    count++;
  });

  document.getElementById('empty').style.display = count ? 'none' : 'block';
}

/* ========= CALENDAR VIEW ========= */
function renderCalendarStack(){
  const divSel   = document.getElementById('division').value;
  const sportSel = document.getElementById('sport').value;
  const wrap = document.getElementById('calendarStack');
  wrap.innerHTML = '';

  const parsed = DATA.map(r => ({...r, dt: parseDate(r.date, r.time)}));
  const months = Array.from(new Set(parsed.filter(x => x.dt).map(x => monthKey(x.dt)))).sort();

  months.forEach(key => {
    const [yS, mS] = key.split('-'); const year = +yS, monthIdx = +mS - 1;

    const byDay = {};
    parsed.forEach(ev => {
      if (!ev.dt) return;
      if (!isAllDivisions(divSel) && ev.division !== divSel) return;
      if (sportSel && ev.sport !== sportSel) return;
      if (ev.dt.getFullYear() === year && ev.dt.getMonth() === monthIdx) {
        const d = ev.dt.getDate();
        (byDay[d] ||= []).push(ev);
      }
    });

    const block = document.createElement('div'); block.className = 'month-block';
    const title = document.createElement('div'); title.className = 'month-title';
    title.textContent = new Date(year, monthIdx, 1).toLocaleString('en-GB', {month:'long', year:'numeric'});

    const calendar = document.createElement('div'); calendar.className = 'calendar';
    const head = document.createElement('div'); head.className = 'cal-head';
    head.innerHTML = '<div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>';
    const grid = document.createElement('div'); grid.className = 'cal-grid';

    let start = new Date(year, monthIdx, 1).getDay(); start = (start === 0) ? 6 : start - 1;
    const daysTotal = new Date(year, monthIdx+1, 0).getDate();

    for (let i=0;i<start;i++){ const c = document.createElement('div'); c.className='cal-cell'; grid.appendChild(c); }
    for (let d=1; d<=daysTotal; d++){
      const cell = document.createElement('div'); cell.className='cal-cell';
      const dn = document.createElement('div'); dn.className='d'; dn.textContent = d; cell.appendChild(dn);

      const chips = document.createElement('div'); chips.className='chips';
      (byDay[d]||[]).sort((a,b)=> a.time.localeCompare(b.time)).forEach(ev => {
        if (ev.opponent === '-' || ev.homeAway.toLowerCase() === 'bye') return;
        const divCls = divisionClass(ev.division);
        const chip = document.createElement('div'); chip.className='chip '+divCls;
        const dot  = document.createElement('span'); dot.className='dot '+(ev.homeAway.toLowerCase()==='home'?'home':'away');
        chip.appendChild(dot);
        const txt  = document.createElement('span'); txt.textContent = ev.division.toUpperCase().replace(' ','');
        chip.appendChild(txt);
        chip.addEventListener('click', (e) => {
          e.stopPropagation();
          openResult({ division: ev.division, date: ev.date, time: ev.time, opponent: ev.opponent });
        });
        chips.appendChild(chip);
      });
      cell.appendChild(chips);
      grid.appendChild(cell);
    }

    calendar.appendChild(head); calendar.appendChild(grid);
    block.appendChild(title); block.appendChild(calendar);
    wrap.appendChild(block);
  });
}

/* ========= RESULTS MODAL ========= */
function openResult(ref){
  const ev = DATA.map(r => ({...r, dt: parseDate(r.date, r.time)}))
                 .find(x => x.date===ref.date && x.division===ref.division && x.opponent===ref.opponent);
  const modal = document.getElementById('modal');
  const body  = document.getElementById('modalBody');

  if (!ev || !ev.dt){
    body.innerHTML = '<div class="card">No details found.</div>';
    modal.classList.add('show'); return;
  }
  const iso = ev.dt.toISOString().slice(0,10);
  const key1 = `${ev.division}|${iso}|${ev.location.toLowerCase()}`;
  const key2 = `${ev.division}|${iso}|${(ev.opponent.split(' ')[0]||'').toLowerCase()}`;
  const res = RESULT_INDEX.get(key1) || RESULT_INDEX.get(key2);

  if (!res){
    body.innerHTML = `<div class="card"><div class="res-head">No result found for ${ev.division} – ${ev.date}</div></div>`;
    modal.classList.add('show'); return;
  }

  const head = `<div class="row-top"><div class="date">${ev.date} • ${ev.time}</div><span class="division-badge ${divisionClass(ev.division)}">${ev.division}</span></div>`;
  const rows = res.rubbers.map(r => `<tr><td>${r.pboro_player}</td><td>${r.opponent_player}</td><td>${r.score}</td></tr>`).join('');
  body.innerHTML = `<div class="card">${head}<div class="opponent" style="margin-top:6px"><strong>${ev.opponent}</strong></div><div class="res-head">Result: <strong>${res.team_score}–${res.opp_score}</strong> (PTSRC – ${ev.opponent})</div><table class="res-table"><thead><tr><th>PTSRC</th><th>Opponent</th><th>Score</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  modal.classList.add('show');
}

/* ========= Wiring ========= */
document.getElementById('modalClose').addEventListener('click', () => document.getElementById('modal').classList.remove('show'));
document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') e.currentTarget.classList.remove('show'); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.getElementById('modal').classList.remove('show'); });

document.getElementById('division').addEventListener('change', () => { renderList(); renderCalendarStack(); });
document.getElementById('sport').addEventListener('change', () => { renderList(); renderCalendarStack(); });

const tabList = document.getElementById('tabList');
const tabCal  = document.getElementById('tabCalendar');
tabList.addEventListener('click', () => { tabList.classList.add('active'); tabCal.classList.remove('active'); document.getElementById('listView').style.display='block'; document.getElementById('calendarView').style.display='none'; });
tabCal.addEventListener('click',  () => { tabCal.classList.add('active');  tabList.classList.remove('active'); document.getElementById('listView').style.display='none';  document.getElementById('calendarView').style.display='block'; });

const modeBtn = document.getElementById('modeBtn');
modeBtn.addEventListener('click', () => {
  const html = document.documentElement;
  const dark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', dark ? 'light' : 'dark');
  modeBtn.textContent = dark ? 'Dark Mode' : 'Light Mode';
  modeBtn.setAttribute('aria-pressed', (!dark).toString());
});

/* Initial render */
renderList();
renderCalendarStack();
</script>
<!-- END MAIN APP SCRIPT -->
